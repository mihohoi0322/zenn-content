---
title: "Terraform ã§ Azure VM Extention (AMA) ã‚’å°å…¥ã™ã‚‹"
emoji: "ğŸ˜½"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Terraform, Azure]
published: true
---
Azure ã§ IaC ã¨ã„ãˆã°ã€ARM Template ã‹ Bicep ãŒæŒ™ã’ã‚‰ã‚Œã‚‹ãŒã€Terraform ã‚‚ä½¿ç”¨ã§ãã‚‹ã€‚ã‚‚ã—ã€åˆ©ç”¨ç’°å¢ƒãŒ Azure ã®ã¿ã§ã‚ã‚‹å ´åˆã¯ Bicep ã®æ–¹ãŒã§ãã‚‹ã“ã¨ãŒå¤šã„ãŸã‚éå¸¸ã«ãŠå‹§ã‚ã—ãŸã„ã¨ã“ã‚ã ãŒã€ä»–ã®ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã‚„ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ãŒæ··åœ¨ã™ã‚‹ç’°å¢ƒã§ã‚ã‚Œã° Terraform ã®æ–¹ãŒè‰¯ã„å ´åˆã‚‚ã‚ã‚‹ã€‚ãªãœãªã‚‰ã°ã€ä»–ã®ç’°å¢ƒã‚‚ Terraform ã§ä½œæˆã§ãã‚‹ã—ã€æ›¸ãæ–¹ã‚’çµ±ä¸€ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‰ã ã€‚

# ä»Šå›ã®ãƒ†ãƒ¼ãƒ: Azure VM ã« Azure Monitorin ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å…¥ã‚Œã‚‹

Azure VM (ä»®æƒ³ãƒã‚·ãƒ³) ã‚’ä½œæˆã™ã‚‹ã¨ãã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚„ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãªã©ã‚’ä½œæˆã™ã‚‹ãŒã€åŒæ™‚ã«ç›£è¦–å‘¨ã‚Šã‚‚å°å…¥ã™ã‚‹ã“ã¨ãŒå¤§åŠã ã€‚Terraform ã§åŒã˜ã“ã¨ã‚’å®Ÿæ–½ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€VM æ‹¡å¼µæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ã€Azure Monitor ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å°å…¥ã™ã‚‹ã“ã¨ã¨ãªã‚‹ã€‚

VM æ‹¡å¼µæ©Ÿèƒ½ã¯ã€Azure VM ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®æ§‹æˆã¨è‡ªå‹•ã‚¿ã‚¹ã‚¯ã‚’æä¾›ã™ã‚‹è¤‡æ•°ã®å°ã•ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚ã‚Šã€Azure Monitor ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä»¥å¤–ã«ã‚‚ Chef ã‚„ Datadog ã®æ‹¡å¼µæ©Ÿèƒ½ã‚’å°å…¥ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚[VM æ‹¡å¼µæ©Ÿèƒ½ã«ã¤ã„ã¦ã®èª¬æ˜](https://learn.microsoft.com/ja-jp/azure/virtual-machines/extensions/features-linux?tabs=azure-cli)

ä»Šå›ã¯ã€ä»¥ä¸‹ã®å†…å®¹ã‚’ Terraform ã§ä½œæˆã™ã‚‹ã€‚

* ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—
* VNet
* ã‚µãƒ–ãƒãƒƒãƒˆ
* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
* ãƒ‡ã‚£ã‚¹ã‚¯
* VM æ‹¡å¼µæ©Ÿèƒ½ (Azure Monitoring ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ)

ã¾ãŸã€Azure Monitoring ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ Log Analytics ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¾Œç¶™ã®ç«‹ã¡ä½ç½®ã¨ãªã£ã¦ãŠã‚Šã€Log Analytics ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè‡ªä½“ã¯ 2024 å¹´ã«æ’ã™ã‚‹ã“ã¨ãŒã™ã§ã«[ç™ºè¡¨](https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/log-analytics-agent)ã•ã‚Œã¦ã„ã‚‹ã€‚

# Terraform ã®ãƒ™ãƒ¼ã‚¹
Terraform ã‚’ä»¥ä¸‹ã® 3 ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ä½œæˆã™ã‚‹ã€‚

* providers.tf
* variables.tf
* main.tf

ä»Šå›ã¯ã€Terraform è‡ªä½“ã®èª¬æ˜ã§ã¯ãªã„ã®ã§ç°¡æ˜“çš„ã«è¨˜è¼‰ã—ãŸã€‚

## providers.tf
Terraform ãŒã©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»¥ä¸Šã‚’è¦æ±‚ã™ã‚‹ã‹ã€ã¾ãŸã¯ä½•ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼(ä¾‹ãˆã° Azure ã‚„ AWS ãªã©ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼) ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã‚’å®£è¨€ã™ã‚‹ã€‚

ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ãŸã€‚

```terraform
terraform {
  required_version = ">=1.3.5"

  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.34.0"
    }
  }
}

provider "azurerm" {
  features {}
}
```

ã“ã®å ´åˆã¯ã€Terraform ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã€1.3.5 ä»¥ä¸Šã§ã‚ã‚‹ã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã€‚ã¾ãŸã€Azurerm (Azure ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼)ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã¨ã€ãã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã¤ã„ã¦ã‚‚è¨˜è¼‰ã‚’ã—ã¦ã„ã‚‹ã€‚

## variables.tf
å¤‰æ•°ã‚’æ ¼ç´ã—ã¦ãŠããƒ•ã‚¡ã‚¤ãƒ«ã€‚ãªãã¦ã‚‚è‰¯ã„ãŒã€åŒã˜æ–‡å­—åˆ—ã‚’ä½¿ã„å›ã—ãŸã‚Šã€å¾Œã‹ã‚‰ä¸€æ‹¬ã§ä¿®æ­£&ç®¡ç†ã™ã‚‹å ´åˆã¯ã€åˆ©ç”¨ã—ãŸã„ã€‚`main.tf` ã«è¨˜è¼‰ã—ã¦ã‚‚è‰¯ã„ãŒã€ç®¡ç†ãŒå¤§å¤‰ãªã®ã§å°‘ãªã„å ´åˆã§ã‚‚åˆ©ç”¨ã—ã¦ãŠã„ãŸæ–¹ãŒã€ã®ã¡ã®è‡ªåˆ†ã‹ã‚‰æ„Ÿè¬ã•ã‚Œã‚‹ã¯ãšã§ã‚ã‚‹ã€‚

ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ãŸã€‚

```terraform
variable "vm_name" {
  default     = "tf-VM"
  description = "Location of the resource group."
}

variable "az_resource_group_name" {
  default = "tf-dev"
}

variable "az_location" {
  default     = "eastus2"
  description = "Location of the resource group."
}

variable "project" {
  default = "tf"
}
```

## main.tf
Terraform ã§ã‚„ã‚ŠãŸã„ã“ã¨ã‚’å…¨ã¦è¨˜è¼‰ã™ã‚‹å ´æ‰€ã€‚
ã‚¼ãƒ­ã‹ã‚‰æ›¸ãå§‹ã‚ã‚‹ã®ã¯éå¸¸ã«éª¨ãŒæŠ˜ã‚Œã‚‹ã®ã§ã€å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰æ‹å€Ÿã™ã‚‹ã“ã¨ãŒå¤šã„ã¨æ€ã†ã€‚

* [Terraform ã‚µã‚¤ãƒˆã® Azure ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs)
* [Azure ã‚µã‚¤ãƒˆã® Terraform ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://learn.microsoft.com/ja-jp/azure/developer/terraform/)

å¤šæ•°ã®ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å«ã‚ãŸã‚µãƒ³ãƒ—ãƒ«ã¯ Azure ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®[ã“ã¡ã‚‰](https://github.com/hashicorp/terraform-provider-azurerm/tree/main/examples)ã«è¨˜è¼‰ãŒã•ã‚Œã¦ã„ã‚‹ã€‚éå¸¸ã«å……å®Ÿã—ã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦å¿…è¦ãªã‚‚ã®ã‚’è¶³ã—å·®ã—ã™ã‚Œã°è‰¯ã„ã¨æ€ã†ã€‚

# VM æ‹¡å¼µæ©Ÿèƒ½ã®è¿½åŠ 
ã“ã“ãŒä»Šå›ã®æœ¬é¡Œã®æ‹¡å¼µæ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹éƒ¨åˆ†ã€‚ä»®æƒ³ãƒã‚·ãƒ³ã«ã¤ã„ã¦ã¯ã€ã“ã®è¿½åŠ ã®å¾Œã«è¨˜è¼‰ã—ã¦ã„ã‚‹ã€‚
æ‹¡å¼µæ©Ÿèƒ½ã‚’å…¥ã‚Œã‚‹å ´åˆã¯ `azurerm_virtual_machine_extension` ã‚’ä½¿ç”¨ã™ã‚‹ã€‚ã“ã‚Œã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ä»®æƒ³ãƒã‚·ãƒ³ã«æ‹¡å¼µæ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

ä»Šå›ã¯ Azure Monitoring ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å°å…¥ã—ãŸã„ãŸã‚ã€publlisher ã¯ `Microsoft.Azure.Monitor` ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
ã“ã® publisher ã®å†…å®¹ã¯ã€[ã“ã¡ã‚‰](https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/agents-overview)ã‚’å‚è€ƒã«ã—ã¦è¿½è¨˜ã™ã‚‹ã€‚
ã¾ãŸã€åŒã˜ãé‡è¦ãª `type` ã‚‚åŒã˜ URL ã‚’å‚è€ƒã«ã—ã¦è¿½è¨˜ã™ã‚‹ã€‚ä»Šå›ã¯ Linux ç”¨ã® Azure Monitoring ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å°å…¥ã™ã‚‹ãŒã€ãã†ã§ãªã„å ´åˆã¯é©å®œèª­ã¿æ›¿ãˆã¦å¤‰æ›´ã™ã‚‹ã€‚
ãã†ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã§è¿½åŠ ãŒã§ãã‚‹ã€‚

```terraform
resource "azurerm_virtual_machine_extension" "example" {
      name                       = "AzureMonitorLinuxAgent"
      publisher                  = "Microsoft.Azure.Monitor"
      type                       = "AzureMonitorLinuxAgent"
      type_handler_version       = "1.24"
      auto_upgrade_minor_version = "false"
    
      virtual_machine_id = azurerm_virtual_machine.example.id
}
```

`aut_upgrade_minor_version` ã¯ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’è‡ªå‹•è¨­å®šã™ã‚‹ã‹ãŒè¨­å®šã§ãã‚‹ã€‚ã“ã‚Œã¯ Azure Portal ã‹ã‚‰ã§ã‚‚å¤‰æ›´ã§ãã‚‹ã€‚
`type_handler_version` ã‚‚ä½¿ç”¨ã—ãŸã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®šã§ãã‚‹ã€‚ãŸã ã—ã€1.x.z ã®ã‚ˆã†ã«ç´°ã‹ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šã¯ã§ããªã‹ã£ãŸã€‚1.x ã¾ã§ã‚’æŒ‡å®šã—ã€ãã® x ã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè‡ªå‹•çš„ã«æŒ‡å®šã•ã‚Œã‚‹å‹•ä½œã ã£ãŸã€‚ï¼ˆã¤ã¾ã‚Šã€1.9.10 ãŒæœ€æ–°ã§ã‚ã‚Œã°ã€1.9 ã¨è¨˜è¼‰ã™ã‚‹ã“ã¨ã§ 1.9.10 ãŒå…¥ã‚‹ã€‚1.9.9 ã‚„ 1.9.0 ã¯å°å…¥ã•ã‚Œãªã„ï¼‰

ã‚ã¨ã¯ã€å¯¾è±¡ã®ä»®æƒ³ãƒã‚·ãƒ³ã‚’æŒ‡å®šã—ã¦å®Œäº†ã€‚

# ä»®æƒ³ãƒã‚·ãƒ³ã®ä½œæˆ
ä»®æƒ³ãƒã‚·ãƒ³ (ã‚·ãƒ³ãƒ—ãƒ«) ã«å¿…è¦ãªã®ã¯ã€ä»¥ä¸‹ã®å†…å®¹ã§ã‚ã‚‹ã€‚

* ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—
* VNet
* ã‚µãƒ–ãƒãƒƒãƒˆ
* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
* ãƒ‡ã‚£ã‚¹ã‚¯
* ä»®æƒ³ãƒã‚·ãƒ³æœ¬ä½“

## ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—

ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã™ã‚‹ã€‚

```terraform
resource "azurerm_resource_group" "example" {
  name     = var.az_resource_group_name
  location = var.az_location
}
```

## VNet ã¨ã‚µãƒ–ãƒãƒƒãƒˆ

VNet ã¨ã‚µãƒ–ãƒãƒƒãƒˆã‚’ä½œæˆã™ã‚‹ã€‚

```terraform
// VNet
resource "azurerm_virtual_network" "example" {
  name                = "acctvn"
  address_space       = ["10.0.0.0/16"]
  location            = azurerm_resource_group.example.location
  resource_group_name = azurerm_resource_group.example.name
}

// ã‚µãƒ–ãƒãƒƒãƒˆ
resource "azurerm_subnet" "example" {
  name                 = "acctsub"
  resource_group_name  = azurerm_resource_group.example.name
  virtual_network_name = azurerm_virtual_network.example.name
  address_prefixes     = ["10.0.2.0/24"]
}
```

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã€‚

```terraform
resource "azurerm_network_interface" "example" {
  name                = "acctni"
  location            = azurerm_resource_group.example.location
  resource_group_name = azurerm_resource_group.example.name

  ip_configuration {
    name                          = "testconfiguration1"
    subnet_id                     = azurerm_subnet.example.id
    private_ip_address_allocation = "Dynamic"
  }
}
```


## ãƒ‡ã‚£ã‚¹ã‚¯

ãƒ‡ã‚£ã‚¹ã‚¯å‘¨ã‚Šã€‚

```terraform
resource "azurerm_storage_account" "example" {
  name                     = "storagename"
  resource_group_name      = azurerm_resource_group.example.name
  location                 = azurerm_resource_group.example.location
  account_tier             = "Standard"
  account_replication_type = "LRS"

  tags = {
    environment = "staging"
  }
}

resource "azurerm_storage_container" "example" {
  name                  = "vhds"
  storage_account_name  = azurerm_storage_account.example.name
  container_access_type = "private"

```

## ä»®æƒ³ãƒã‚·ãƒ³

ä»®æƒ³ãƒã‚·ãƒ³ã‚’ä½œæˆã™ã‚‹ã€‚ä»Šã¾ã§ä½œæˆã—ã¦ããŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãªã©ã®æƒ…å ±ã‚’ä¸€æ°—ã«ç´ä»˜ã‘ã‚‹ã€‚

```terraform
resource "azurerm_virtual_machine" "example" {
  name                  = var.vm_name
  location              = azurerm_resource_group.example.location
  resource_group_name   = azurerm_resource_group.example.name
  network_interface_ids = [azurerm_network_interface.example.id]
  vm_size               = "Standard_F2"

  storage_image_reference {
    publisher = "Canonical"
    offer     = "UbuntuServer"
    sku       = "16.04-LTS"
    version   = "latest"
  }

  storage_os_disk {
    name          = "myosdisk1"
    vhd_uri       = "${azurerm_storage_account.example.primary_blob_endpoint}${azurerm_storage_container.example.name}/myosdisk1.vhd"
    caching       = "ReadWrite"
    create_option = "FromImage"
  }

  os_profile {
    computer_name  = var.vm_name
    admin_username = "azureadmin"
    admin_password = "XXXXXX"
  }

  os_profile_linux_config {
    disable_password_authentication = false
  }

  tags = {
    environment = "staging"
  }
}
```

# å®Ÿè¡Œã™ã‚‹
ã“ã‚Œã‚‰ã‚’å…¨ã¦åˆã‚ã›ã¦ï¼ˆä»®æƒ³ãƒã‚·ãƒ³ã‚’æœ€åˆã«è¨˜è¿°ï¼‰ã€å®Ÿè¡Œã™ã‚‹ã¨ä»®æƒ³ãƒã‚·ãƒ³ãŠã‚ˆã³æ‹¡å¼µæ©Ÿèƒ½ãŒä½œæˆã•ã‚Œã‚‹ã€‚

```bash
$ terraform init
$ terraform plan
```

ã§ã€ç‰¹ã«ã‚¨ãƒ©ãƒ¼ã‚‚å‡ºãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦

```bash
% terraform apply

Terraform used the selected providers to generate the following execution plan. Resource actions are
indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # azurerm_network_interface.example will be created
  + resource "azurerm_network_interface" "example" {
      + applied_dns_servers           = (known after apply)
      + dns_servers                   = (known after apply)
      + enable_accelerated_networking = false
(ç•¥)
Apply complete! Resources: 8 added, 0 changed, 0 destroyed.
```

Azure Portal ã‚’è¦‹ã«è¡Œãã¨ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚‹ã€‚

# ãŠã‚ã‚Šã«
Terraform ã§ä»®æƒ³ãƒã‚·ãƒ³ã‚’ä½œæˆã—ã€ãã“ã«å¯¾ã—ã¦ Azure Monitoring ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå°å…¥ã§ããŸã€‚é€šå¸¸ã¯â€ä½œã‚Œã‚‹ã“ã¨â€ä»¥å¤–ã®ç¢ºèªã§ã‚ã‚Œã°ã€ä»®æƒ³ãƒã‚·ãƒ³ä»¥å¤–ã«ã‚‚ä»˜éšã—ã¦ä½œæˆãŒå¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã¯ã‚ã‚‹ã¯ãšãªã®ã§ã€ã“ã†ã„ã£ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚‚ãã®ä¸­ã®1ã¤ã ã¨æ€ã†ã€‚